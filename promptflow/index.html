<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PromptFlow | Simple AI Architect</title>

    <!-- PWA Settings -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#005C97">
    <link rel="apple-touch-icon" href="icon.svg">

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        darkBg: '#0F172A',
                        darkCard: '#1E293B',
                        darkBorder: '#334155'
                    }
                }
            }
        }
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lucide/0.263.1/lucide.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        .accent-gradient {
            background: linear-gradient(135deg, #00A8E8 0%, #005C97 100%);
        }

        .glass-card {
            background: #FFFFFF;
            border: 1px solid rgba(0, 0, 0, 0.05);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.04);
            transition: background-color 0.2s, border-color 0.2s;
        }

        .dark .glass-card {
            background: #1E293B;
            border: 1px solid #334155;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.2);
        }

        .input-focus:focus {
            border-color: #00A8E8;
            box-shadow: 0 0 0 4px rgba(0, 168, 232, 0.1);
        }

        .loader-bar {
            width: 0%;
            transition: width 1.5s cubic-bezier(0.65, 0, 0.35, 1);
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-slide-up {
            animation: slideUp 0.5s ease-out forwards;
        }

        /* Mobile slider thumb styling */
        input[type=range]::-webkit-slider-thumb {
            height: 24px;
            width: 24px;
            border-radius: 50%;
            background: #00A8E8;
            cursor: pointer;
            -webkit-appearance: none;
            margin-top: -8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        /* Custom scrollbar for history sidebar */
        .history-scroll::-webkit-scrollbar {
            width: 6px;
        }

        .history-scroll::-webkit-scrollbar-track {
            background: transparent;
        }

        .history-scroll::-webkit-scrollbar-thumb {
            background-color: #CBD5E1;
            border-radius: 20px;
        }
    </style>
</head>

<body
    class="min-h-screen flex flex-col md:flex-row overflow-hidden bg-[#F5F7FA] dark:bg-slate-900 text-[#333333] dark:text-slate-200 transition-colors duration-200"
    id="app-body">



    <!-- History Sidebar -->
    <aside
        class="w-full md:w-80 h-[300px] md:h-screen bg-white md:bg-white/80 md:backdrop-blur-md border-r border-gray-100 flex flex-col md:sticky md:top-0 z-40 shrink-0 shadow-[4px_0_24px_-12px_rgba(0,0,0,0.05)] order-2 md:order-1">
        <div
            class="p-5 md:p-6 border-b border-gray-100 bg-white sticky top-0 z-10 dark:bg-slate-900 dark:border-slate-800 transition-colors">
            <div class="flex items-center justify-between mb-2">
                <h2
                    class="text-base md:text-lg font-bold text-[#005C97] dark:text-[#38BDF8] flex items-center gap-2 transition-colors">
                    <i data-lucide="history" class="w-5 h-5"></i> Prompt History
                </h2>
                <div class="flex items-center gap-2">
                    <button onclick="exportHistory()"
                        class="text-xs font-bold text-[#005C97] bg-blue-50 hover:bg-[#005C97] hover:text-white dark:bg-slate-800 dark:text-blue-400 dark:border-slate-700 dark:hover:bg-blue-900 dark:hover:text-blue-200 px-2.5 py-1.5 rounded-lg border border-blue-100 transition-all shadow-sm flex items-center gap-1.5"
                        title="Export history to TXT">
                        <i data-lucide="download" class="w-3.5 h-3.5"></i>
                    </button>
                    <button onclick="clearHistory()"
                        class="text-xs font-bold text-red-500 bg-red-50 hover:bg-red-500 hover:text-white dark:bg-slate-800 dark:border-slate-700 dark:hover:bg-red-900 dark:hover:text-red-200 px-2.5 py-1.5 rounded-lg border border-red-100 transition-all shadow-sm flex items-center gap-1.5"
                        title="Clear all history">
                        <i data-lucide="trash-2" class="w-3.5 h-3.5"></i>
                    </button>
                </div>
            </div>
            <p class="text-xs text-gray-400 dark:text-slate-500">Your generated blueprints.</p>
        </div>
        <div id="history-list" class="flex-1 p-4 space-y-3 overflow-y-auto history-scroll bg-gray-50/50">
            <!-- Loading state -->
            <div class="text-center py-8 text-sm text-gray-400 flex flex-col items-center gap-2">
                <i data-lucide="ghost" class="w-6 h-6 text-gray-300"></i>
                No history yet. Generating a prompt will save it here.
            </div>
        </div>
    </aside>

    <!-- Main Content Area -->
    <div class="flex-1 flex flex-col min-w-0 order-1 md:order-2">
        <!-- Sticky Header -->
        <header
            class="bg-white/90 backdrop-blur-md border-b border-gray-100 py-3 px-4 md:px-6 sticky top-0 z-50 dark:bg-slate-900/90 dark:border-slate-800 transition-colors">
            <div class="max-w-5xl mx-auto flex justify-between items-center">
                <div class="flex items-center gap-2">
                    <div
                        class="w-8 h-8 md:w-10 md:h-10 accent-gradient rounded-lg md:rounded-xl flex items-center justify-center shadow-lg shadow-cyan-500/20">
                        <i data-lucide="zap" class="text-white w-5 h-5 md:w-6 md:h-6"></i>
                    </div>
                    <h1
                        class="text-lg md:text-xl font-bold tracking-tight text-[#005C97] dark:text-[#38BDF8] flex items-center">
                        Prompt<span class="text-[#00A8E8]">Flow</span>
                        <span id="header-pro-badge"
                            class="hidden ml-2 text-[10px] md:text-xs uppercase font-extrabold bg-gradient-to-r from-yellow-400 to-yellow-600 text-white px-2 py-0.5 rounded shadow-sm">PRO</span>
                    </h1>
                </div>

                <div class="flex items-center gap-3">
                    <button id="header-settings-btn" onclick="showSettingsModal()"
                        class="hidden p-2 text-gray-500 hover:text-[#00A8E8] dark:text-slate-400 dark:hover:text-[#38BDF8] transition-colors rounded-full hover:bg-gray-50 dark:hover:bg-slate-800"
                        title="Pro Settings">
                        <!-- Settings SVG -->
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                            class="w-5 h-5">
                            <path
                                d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z">
                            </path>
                            <circle cx="12" cy="12" r="3"></circle>
                        </svg>
                    </button>
                    <button onclick="toggleTheme()"
                        class="p-2 text-gray-500 hover:text-[#00A8E8] dark:text-slate-400 dark:hover:text-yellow-400 transition-colors rounded-full hover:bg-gray-50 dark:hover:bg-slate-800"
                        title="Toggle Dark Mode">
                        <!-- Moon SVG -->
                        <svg id="moon-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20"
                            viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                            stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5 block dark:hidden">
                            <path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"></path>
                        </svg>
                        <!-- Sun SVG -->
                        <svg id="sun-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24"
                            fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                            stroke-linejoin="round" class="w-5 h-5 hidden dark:block">
                            <circle cx="12" cy="12" r="4"></circle>
                            <path d="M12 2v2"></path>
                            <path d="M12 20v2"></path>
                            <path d="m4.93 4.93 1.41 1.41"></path>
                            <path d="m17.66 17.66 1.41 1.41"></path>
                            <path d="M2 12h2"></path>
                            <path d="M20 12h2"></path>
                            <path d="m6.34 17.66-1.41 1.41"></path>
                            <path d="m19.07 4.93-1.41 1.41"></path>
                        </svg>
                    </button>
                    <button id="header-upgrade-btn" onclick="showProModal()"
                        class="text-xs md:text-sm font-bold text-white bg-gradient-to-r from-yellow-400 to-yellow-600 hover:from-yellow-500 hover:to-yellow-700 px-4 py-2 rounded-full shadow-lg shadow-yellow-500/30 transition-all flex items-center gap-2">
                        <i data-lucide="crown" class="w-4 h-4 text-yellow-100"></i> <span
                            class="hidden md:inline">Upgrade to Pro</span>
                    </button>
                </div>
            </div>
        </header>

        <!-- Main Workspace Area - added scrollable class -->
        <div class="flex-1 overflow-y-auto h-screen relative pb-12">
            <main class="w-full max-w-4xl mx-auto px-4 md:px-6 py-6 md:py-10">
                <!-- Intro Section -->
                <div class="text-center mb-8 md:mb-12">
                    <h2 class="text-2xl md:text-4xl font-extrabold mb-3 px-2 dark:text-white transition-colors">Write
                        better AI prompts, instantly.</h2>
                    <p
                        class="text-gray-500 dark:text-slate-400 text-sm md:text-lg max-w-2xl mx-auto px-4 leading-relaxed transition-colors">
                        Simple words in, professional prompts out. Get more accurate answers from any AI model.
                    </p>
                </div>

                <!-- Input Flow -->
                <div id="input-container" class="space-y-4 md:space-y-6 animate-slide-up">
                    <div class="glass-card rounded-2xl p-5 md:p-8">

                        <!-- Step 1: Main Text -->
                        <div class="mb-6 md:mb-8">
                            <label
                                class="flex items-center gap-2 text-xs md:text-sm font-bold text-gray-600 mb-3 uppercase tracking-widest">
                                <i data-lucide="message-square" class="w-4 h-4 text-[#00A8E8]"></i>
                                1. Your Main Goal
                            </label>
                            <textarea id="user-goal"
                                class="w-full p-4 bg-gray-50 border border-gray-200 rounded-xl min-h-[140px] md:min-h-[120px] outline-none input-focus transition-all text-base md:text-lg placeholder:text-gray-400 dark:bg-slate-900 dark:border-slate-700 dark:text-white dark:placeholder-slate-500"
                                placeholder="e.g. Help me plan a 3-day trip to Tokyo on a budget..."></textarea>
                        </div>

                        <!-- Step 2: Keywords & Complexity -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 md:gap-8 mb-6 md:mb-8">
                            <div>
                                <label
                                    class="flex items-center gap-2 text-xs md:text-sm font-bold text-gray-600 dark:text-slate-300 mb-3 uppercase tracking-widest transition-colors">
                                    <i data-lucide="hash" class="w-4 h-4 text-[#00A8E8]"></i>
                                    2. Style or Keywords
                                </label>
                                <input id="user-keywords" type="text"
                                    class="w-full p-4 bg-gray-50 border border-gray-200 rounded-xl outline-none input-focus transition-all text-sm md:text-base dark:bg-slate-900 dark:border-slate-700 dark:text-white dark:placeholder-slate-500"
                                    placeholder="Expert, funny, brief...">
                            </div>
                            <div>
                                <label
                                    class="flex items-center gap-2 text-xs md:text-sm font-bold text-gray-600 dark:text-slate-300 mb-3 uppercase tracking-widest transition-colors">
                                    <i data-lucide="layers" class="w-4 h-4 text-[#00A8E8]"></i>
                                    3. Complexity (1-10)
                                </label>
                                <div
                                    class="flex items-center gap-4 h-14 bg-gray-50 px-4 rounded-xl border border-gray-200 dark:bg-slate-900 dark:border-slate-700 transition-colors">
                                    <input type="range" id="complexity" min="1" max="10" value="5"
                                        class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                                    <span id="complexity-val"
                                        class="font-bold text-[#005C97] dark:text-[#38BDF8] min-w-[20px] text-center transition-colors">5</span>
                                </div>
                            </div>
                        </div>

                        <!-- Step 3: Images & Numbers -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 md:gap-8">
                            <div>
                                <label
                                    class="flex items-center gap-2 text-xs md:text-sm font-bold text-gray-600 dark:text-slate-300 mb-3 uppercase tracking-widest transition-colors">
                                    <i data-lucide="image" class="w-4 h-4 text-[#00A8E8]"></i>
                                    4. Image Context (Link)
                                </label>
                                <input id="user-image" type="text"
                                    class="w-full p-4 bg-gray-50 border border-gray-200 rounded-xl outline-none input-focus transition-all text-sm md:text-base dark:bg-slate-900 dark:border-slate-700 dark:text-white dark:placeholder-slate-500"
                                    placeholder="Paste image URL (optional)">
                            </div>
                            <div>
                                <label
                                    class="flex items-center gap-2 text-xs md:text-sm font-bold text-gray-600 mb-3 uppercase tracking-widest">
                                    <i data-lucide="bar-chart-2" class="w-4 h-4 text-[#00A8E8]"></i>
                                    5. Important Numbers
                                </label>
                                <input id="user-values" type="text"
                                    class="w-full p-4 bg-gray-50 border border-gray-200 rounded-xl outline-none input-focus transition-all text-sm md:text-base dark:bg-slate-900 dark:border-slate-700 dark:text-white dark:placeholder-slate-500"
                                    placeholder="Budget: $500, People: 2...">
                            </div>
                        </div>

                        <div class="mt-8 md:mt-10">
                            <button onclick="processPrompt()"
                                class="w-full accent-gradient text-white py-4 md:py-5 rounded-xl font-bold text-base md:text-lg shadow-xl shadow-cyan-500/30 hover:shadow-cyan-500/40 transition-all flex items-center justify-center gap-3">
                                Build Expert Prompt
                                <i data-lucide="arrow-right" class="w-5 h-5"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Mobile-Friendly Processing State -->
                <div id="processing-container" class="hidden animate-slide-up">
                    <div class="glass-card rounded-2xl p-10 md:p-16 text-center">
                        <div id="loading-icon-container"
                            class="w-16 h-16 md:w-20 md:h-20 accent-gradient rounded-full flex items-center justify-center mx-auto mb-6 shadow-xl animate-pulse">
                            <i id="loading-icon" data-lucide="cpu" class="text-white w-8 h-8 md:w-10 md:h-10"></i>
                        </div>
                        <h3 class="text-xl md:text-2xl font-bold mb-2 dark:text-white transition-colors">Analyzing
                            Intent...</h3>
                        <p class="text-gray-500 text-sm md:text-base mb-8 dark:text-slate-400 transition-colors">
                            Structuring your expert action plan.</p>
                        <div
                            class="w-full bg-gray-100 h-2 rounded-full overflow-hidden max-w-xs mx-auto dark:bg-slate-700">
                            <div id="progress-bar" class="loader-bar h-full accent-gradient"></div>
                        </div>
                    </div>
                </div>

                <!-- Results Section -->
                <div id="results-container" class="hidden space-y-6 animate-slide-up">
                    <div class="flex items-center justify-between px-1">
                        <h3 class="text-xl md:text-2xl font-bold text-[#333333] dark:text-white transition-colors">Your
                            Prompt Blueprint</h3>
                        <button onclick="resetApp()"
                            class="text-xs md:text-sm font-bold text-[#00A8E8] flex items-center gap-1 bg-cyan-50 px-3 py-1.5 rounded-full hover:bg-cyan-100 dark:bg-slate-800 dark:text-[#38BDF8] dark:hover:bg-slate-700 transition-colors">
                            <i data-lucide="rotate-ccw" class="w-3 h-3 md:w-4 h-4"></i> New Prompt
                        </button>
                    </div>

                    <!-- Primary Output Card -->
                    <div
                        class="glass-card rounded-2xl overflow-hidden border-2 border-cyan-100 dark:border-slate-600 transition-colors">
                        <div class="p-6 md:p-8">
                            <div class="flex flex-wrap items-center justify-between gap-4 mb-4">
                                <div
                                    class="flex items-center gap-2 text-[#00A8E8] dark:text-[#38BDF8] font-bold text-[10px] md:text-xs uppercase tracking-[0.2em] transition-colors">
                                    <i data-lucide="check-square" class="w-4 h-4"></i> Perfected Prompt
                                </div>
                                <button onclick="copyText()" id="copy-btn"
                                    class="flex items-center gap-2 text-xs font-bold text-gray-500 bg-gray-50 hover:bg-gray-100 px-4 py-2 rounded-lg border border-gray-200 transition-colors dark:bg-slate-900 dark:border-slate-700 dark:text-gray-300 dark:hover:bg-slate-800">
                                    <i data-lucide="copy" class="w-4 h-4 text-[#00A8E8] dark:text-[#38BDF8]"></i>
                                    <span>Copy Prompt</span>
                                </button>
                            </div>
                            <div
                                class="bg-gray-50 p-5 md:p-6 rounded-xl border border-gray-100 dark:bg-slate-900 dark:border-slate-700 transition-colors">
                                <p id="output-prompt"
                                    class="text-base md:text-lg leading-relaxed text-gray-700 italic dark:text-slate-300">
                                    <!-- Injected by JS -->
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- Action Recommendations Grid -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div
                            class="glass-card p-5 rounded-2xl flex md:flex-col gap-4 md:gap-0 items-center md:items-start">
                            <div
                                class="w-10 h-10 shrink-0 bg-blue-50 rounded-lg flex items-center justify-center md:mb-4 dark:bg-slate-900/50">
                                <i data-lucide="clipboard-copy" class="text-[#005C97] dark:text-[#38BDF8] w-5 h-5"></i>
                            </div>
                            <div>
                                <h4 class="font-bold text-sm md:text-base text-[#005C97] dark:text-[#38BDF8]">1. Copy
                                    Prompt</h4>
                                <p class="text-[11px] md:text-xs text-gray-500 leading-normal mt-1 dark:text-slate-400">
                                    Ready to use in
                                    ChatGPT,
                                    Claude, or Midjourney.</p>
                            </div>
                        </div>
                        <div
                            class="glass-card p-5 rounded-2xl flex md:flex-col gap-4 md:gap-0 items-center md:items-start">
                            <div
                                class="w-10 h-10 shrink-0 bg-cyan-50 rounded-lg flex items-center justify-center md:mb-4 dark:bg-slate-900/50">
                                <i data-lucide="message-square-plus"
                                    class="text-[#00A8E8] dark:text-[#38BDF8] w-5 h-5"></i>
                            </div>
                            <div>
                                <h4 class="font-bold text-sm md:text-base text-[#005C97] dark:text-[#38BDF8]">2. Add
                                    Context</h4>
                                <p class="text-[11px] md:text-xs text-gray-500 leading-normal mt-1 dark:text-slate-400">
                                    If results are too
                                    broad, ask the AI to "focus on keywords."</p>
                            </div>
                        </div>
                        <div
                            class="glass-card p-5 rounded-2xl flex md:flex-col gap-4 md:gap-0 items-center md:items-start">
                            <div
                                class="w-10 h-10 shrink-0 bg-green-50 rounded-lg flex items-center justify-center md:mb-4 dark:bg-slate-900/50">
                                <i data-lucide="bar-chart" class="text-green-600 dark:text-green-400 w-5 h-5"></i>
                            </div>
                            <div>
                                <h4 class="font-bold text-sm md:text-base text-[#005C97] dark:text-[#38BDF8]">3. Use
                                    Values</h4>
                                <p class="text-[11px] md:text-xs text-gray-500 leading-normal mt-1 dark:text-slate-400">
                                    Ask the AI to format
                                    the
                                    "numbers" into a table.</p>
                            </div>
                        </div>
                    </div>

                    <!-- Dashboard Summary -->
                    <div class="glass-card p-6 md:p-8 rounded-2xl accent-gradient text-white">
                        <div class="flex items-center gap-3 mb-4 md:mb-6">
                            <i data-lucide="info" class="w-5 h-5 text-cyan-200"></i>
                            <h4 class="text-lg font-bold">Expert Recommendations</h4>
                        </div>
                        <div class="space-y-4 text-xs md:text-sm text-white/90">
                            <div class="flex gap-3 items-start">
                                <div
                                    class="w-5 h-5 rounded-full bg-white/20 flex items-center justify-center text-[10px] shrink-0">
                                    A</div>
                                <p>We used <strong>Role Prompting</strong>: Telling the AI to be an expert makes it 30%
                                    more
                                    accurate.</p>
                            </div>
                            <div class="flex gap-3 items-start">
                                <div
                                    class="w-5 h-5 rounded-full bg-white/20 flex items-center justify-center text-[10px] shrink-0">
                                    B</div>
                                <p>We added <strong>Constraint Logic</strong>: Using your specific numbers prevents the
                                    AI
                                    from "hallucinating" or lying.</p>
                            </div>
                        </div>
                    </div>

                </div>
            </main>
        </div>
    </div>

    <!-- Pro Upgrade Modal -->
    <div id="pro-modal"
        class="hidden fixed inset-0 z-[100] bg-gray-900/60 backdrop-blur-sm flex items-center justify-center">
        <div
            class="glass-card dark:bg-slate-800 dark:border-slate-700 rounded-2xl p-8 max-w-sm w-full mx-4 shadow-2xl animate-slide-up bg-white relative">
            <button onclick="closeProModal()"
                class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 dark:hover:text-gray-200">
                <!-- X SVG -->
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                    class="w-5 h-5">
                    <path d="M18 6 6 18"></path>
                    <path d="m6 6 12 12"></path>
                </svg>
            </button>
            <div id="pro-modal-content">
                <div class="text-center mb-6">
                    <div
                        class="w-12 h-12 md:w-14 md:h-14 bg-gradient-to-br from-yellow-400 to-yellow-600 rounded-xl flex items-center justify-center shadow-lg shadow-yellow-500/20 mx-auto mb-4">
                        <i data-lucide="crown" class="text-white w-6 h-6 md:w-8 md:h-8"></i>
                    </div>
                    <h2 class="text-xl md:text-2xl font-extrabold text-[#005C97] dark:text-yellow-500 mb-1">Upgrade to
                        Pro
                    </h2>
                    <p class="text-xs text-gray-500 dark:text-gray-400">Unlock the full power of PromptFlow.</p>
                </div>

                <div class="space-y-4 mb-6 text-sm text-gray-600 dark:text-gray-300">
                    <div class="flex items-center gap-3">
                        <i data-lucide="check-circle-2" class="w-5 h-5 text-green-500"></i>
                        <span><strong>Cloud Sync</strong> across all devices</span>
                    </div>
                    <div class="flex items-center gap-3">
                        <i data-lucide="check-circle-2" class="w-5 h-5 text-green-500"></i>
                        <span><strong>Unlimited</strong> prompt history</span>
                    </div>
                    <div class="flex items-center gap-3">
                        <i data-lucide="check-circle-2" class="w-5 h-5 text-green-500"></i>
                        <span><strong>Custom</strong> system prompts</span>
                    </div>
                </div>
                <button id="subscribe-btn" onclick="subscribePro()"
                    class="w-full bg-gradient-to-r from-yellow-400 to-yellow-600 text-white py-3 rounded-xl font-bold text-sm md:text-base shadow-lg shadow-yellow-500/30 hover:shadow-yellow-500/40 transition-all flex items-center justify-center gap-2">
                    Subscribe for $4.99/mo
                </button>
            </div>
        </div>
    </div>
    </div>

    <!-- Settings Modal (Pro) -->
    <div id="settings-modal"
        class="hidden fixed inset-0 z-[100] bg-gray-900/60 backdrop-blur-sm flex items-center justify-center">
        <div
            class="glass-card dark:bg-slate-800 dark:border-slate-700 rounded-2xl p-6 md:p-8 max-w-md w-full mx-4 shadow-2xl animate-slide-up bg-white relative">
            <button onclick="closeSettingsModal()"
                class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 dark:hover:text-gray-200">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                    class="w-5 h-5">
                    <path d="M18 6 6 18"></path>
                    <path d="m6 6 12 12"></path>
                </svg>
            </button>

            <div class="flex items-center gap-3 mb-6">
                <div class="w-10 h-10 bg-cyan-50 dark:bg-slate-700 rounded-lg flex items-center justify-center">
                    <i data-lucide="settings" class="text-[#00A8E8] dark:text-[#38BDF8] w-5 h-5"></i>
                </div>
                <div>
                    <h2 class="text-xl font-bold text-[#333333] dark:text-white">Pro Settings</h2>
                    <p class="text-xs text-gray-500 dark:text-gray-400">Configure your global preferences.</p>
                </div>
            </div>

            <div class="space-y-4">
                <div>
                    <label
                        class="flex items-center justify-between text-sm font-bold text-gray-700 dark:text-slate-300 mb-2">
                        <span>Custom System Prompt</span>
                        <span
                            class="text-[10px] bg-[#00A8E8]/10 text-[#00A8E8] dark:text-[#38BDF8] px-2 py-0.5 rounded uppercase tracking-wider">Premium</span>
                    </label>
                    <p class="text-xs text-gray-500 dark:text-slate-400 mb-3 leading-relaxed">
                        These instructions will be silently injected into every prompt blueprint you generate. Use this
                        to enforce specific formats, languages, or personas.
                    </p>
                    <textarea id="system-prompt-input"
                        class="w-full p-4 bg-gray-50 border border-gray-200 rounded-xl min-h-[120px] outline-none input-focus transition-all text-sm placeholder:text-gray-400 dark:bg-slate-900 dark:border-slate-700 dark:text-white dark:placeholder-slate-500"
                        placeholder="e.g. Always format the output as a Markdown table. Be concise and authoritative."></textarea>
                </div>
            </div>

            <div class="mt-6 flex gap-3">
                <button onclick="closeSettingsModal()"
                    class="flex-1 py-2.5 rounded-xl font-bold text-sm text-gray-600 bg-gray-100 hover:bg-gray-200 dark:bg-slate-700 dark:text-slate-300 dark:hover:bg-slate-600 transition-colors">
                    Cancel
                </button>
                <button onclick="saveSettings()"
                    class="flex-1 accent-gradient text-white py-2.5 rounded-xl font-bold text-sm shadow-lg shadow-cyan-500/30 hover:shadow-cyan-500/40 transition-all">
                    Save Changes
                </button>
            </div>

            <div class="mt-4 text-center border-t border-gray-100 dark:border-slate-700 pt-4">
                <button onclick="downgradeToFree()"
                    class="text-xs font-bold text-red-500 hover:text-red-600 dark:text-red-400 dark:hover:text-red-500 transition-colors flex items-center justify-center gap-1 mx-auto">
                    <i data-lucide="log-out" class="w-3 h-3"></i> Clear Pro Status (Testing Only)
                </button>
            </div>
        </div>
    </div>

    <!-- DB LOGIC -->
    <script>
        // Register Service Worker for PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js').then((reg) => {
                    console.log('ServiceWorker registration successful');
                }).catch((err) => {
                    console.log('ServiceWorker registration failed: ', err);
                });
            });
        }

        // Database Configuration
        const DB_NAME = "PromptFlowDB";
        const STORE_NAME = "history";
        let db;

        // Initialize IndexedDB
        function initDB() {
            return new Promise((resolve, reject) => {
                // Open with version 2 since it was previously upgraded
                const request = indexedDB.open(DB_NAME, 2);

                request.onupgradeneeded = (event) => {
                    const database = event.target.result;
                    if (!database.objectStoreNames.contains(STORE_NAME)) {
                        // Create object store with auto-increment ID
                        const store = database.createObjectStore(STORE_NAME, { keyPath: "id", autoIncrement: true });
                        store.createIndex("created_at", "created_at", { unique: false });
                    }
                };

                request.onsuccess = (event) => {
                    db = event.target.result;
                    resolve(db);
                };

                request.onerror = (event) => {
                    console.error("IndexedDB error:", event.target.error);
                    reject(event.target.error);
                };
            });
        }

        // Save Prompt to History
        function savePromptToHistory(promptData) {
            return new Promise((resolve, reject) => {
                if (!db) return reject("DB not initialized");

                const transaction = db.transaction([STORE_NAME], "readwrite");
                const store = transaction.objectStore(STORE_NAME);

                // Add timestamp
                promptData.created_at = new Date().toISOString();

                const request = store.add(promptData);

                request.onsuccess = () => resolve(request.result);
                request.onerror = (event) => reject(event.target.error);
            });
        }

        // Get All Prompts
        function getHistory() {
            return new Promise((resolve, reject) => {
                if (!db) return reject("DB not initialized");

                const transaction = db.transaction([STORE_NAME], "readonly");
                const store = transaction.objectStore(STORE_NAME);
                const request = store.getAll();

                request.onsuccess = () => {
                    // Sort descending manually (newest first)
                    const results = request.result.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
                    resolve(results);
                };
                request.onerror = (event) => reject(event.target.error);
            });
        }

        // Clear All History
        function clearHistory() {
            if (!db) {
                alert("Database not ready yet.");
                return;
            }

            const transaction = db.transaction([STORE_NAME], "readwrite");
            const store = transaction.objectStore(STORE_NAME);
            const request = store.clear();

            request.onsuccess = () => {
                refreshSidebar(); // Re-render the sidebar to show empty state
            };

            request.onerror = (event) => {
                console.error("Failed to clear history:", event.target.error);
                alert("Failed to clear history.");
            };
        }
    </script>

    <!-- APP LOGIC -->
    <script>
        function safeCreateIcons() {
            if (typeof lucide !== 'undefined' && lucide.createIcons) {
                lucide.createIcons();
            }
        }

        safeCreateIcons();

        // Complexity slider sync
        const slider = document.getElementById('complexity');
        const sliderVal = document.getElementById('complexity-val');
        slider.addEventListener('input', () => {
            sliderVal.innerText = slider.value;
        });

        // Load DB and render history on startup
        document.addEventListener("DOMContentLoaded", async () => {
            try {
                // Init database always
                await initDB();
                await refreshSidebar();
                updateUIForPro();
            } catch (err) {
                console.error("Failed to init DB or load history", err);
            }
        });

        async function refreshSidebar() {
            try {
                const history = await getHistory();
                renderHistory(history);
            } catch (e) {
                console.error("Rendering history error:", e);
            }
        }

        function renderHistory(items) {
            const list = document.getElementById('history-list');
            if (!items || items.length === 0) {
                list.innerHTML = `
                    <div class="text-center py-8 text-sm text-gray-400 flex flex-col items-center gap-2">
                        <i data-lucide="ghost" class="w-6 h-6 text-gray-300"></i>
                        No history yet. Generating a prompt will save it here.
                    </div>`;
                safeCreateIcons();
                return;
            }

            // Using escapeHtml helper specifically for text that might contain code or quotes
            list.innerHTML = items.map(item => `
                <div class="bg-white p-4 rounded-xl border border-gray-100 shadow-sm hover:shadow-md transition-shadow cursor-pointer select-none" 
                     onclick="loadHistoryItem(this)" 
                     data-fullprompt="${escapeHtmlAttribute(item.generated_prompt)}">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-[10px] font-bold text-gray-400 uppercase tracking-wider">${new Date(item.created_at).toLocaleString()}</span>
                        <span class="text-[10px] font-bold bg-cyan-50 text-[#00A8E8] px-1.5 py-0.5 rounded">Lv.${item.complexity}</span>
                    </div>
                    <p class="text-sm font-medium text-gray-700 line-clamp-2 leading-tight">
                        ${escapeHtml(item.goal)}
                    </p>
                    <div class="mt-2 text-xs text-gray-400 line-clamp-1 italic">
                        ${escapeHtml(item.generated_prompt).substring(0, 60)}...
                    </div>
                </div>
            `).join('');

            safeCreateIcons();
        }

        // Helper to prevent XSS in rendering
        function escapeHtml(unsafe) {
            if (!unsafe) return '';
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        // Helper specifically for placing data into attributes (protects against single/double quote breaks)
        function escapeHtmlAttribute(unsafe) {
            if (!unsafe) return '';
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#39;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;");
        }

        function loadHistoryItem(element) {
            const promptText = element.getAttribute('data-fullprompt');
            document.getElementById('input-container').classList.add('hidden');
            document.getElementById('processing-container').classList.add('hidden');

            // Revert basic HTML tags for display if they were generated via our template
            let displayText = promptText
                .replace(/&lt;br&gt;/g, '<br>')
                .replace(/&lt;strong&gt;/g, '<strong>')
                .replace(/&lt;\/strong&gt;/g, '</strong>')
                .replace(/\\n/g, '<br>'); // ensure newlines wrap properly if standard text

            document.getElementById('output-prompt').innerHTML = displayText;

            document.getElementById('results-container').classList.remove('hidden');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        async function processPrompt() {
            const goal = document.getElementById('user-goal').value;
            if (!goal.trim()) {
                alert("Please type your goal first!");
                return;
            }

            // UI State Change
            document.getElementById('input-container').classList.add('hidden');
            document.getElementById('processing-container').classList.remove('hidden');
            window.scrollTo({ top: 0, behavior: 'smooth' });

            // Reset loader state just in case
            const loadingContainer = document.getElementById('loading-icon-container');
            const loadingIcon = document.getElementById('loading-icon');

            loadingContainer.className = "w-16 h-16 md:w-20 md:h-20 accent-gradient rounded-full flex items-center justify-center mx-auto mb-6 shadow-xl animate-pulse";
            loadingIcon.setAttribute('data-lucide', 'cpu');
            safeCreateIcons();

            // Progress Bar Animation
            setTimeout(() => {
                document.getElementById('progress-bar').style.width = '100%';
            }, 100);

            // Payload details
            const keywords = document.getElementById('user-keywords').value || "professional and thorough";
            const values = document.getElementById('user-values').value || "standard metrics";
            const complexity = document.getElementById('complexity').value;

            // Generate Structured Prompt Blueprint
            let generatedPrompt = '';

            // Inject System Prompt if Pro
            const systemPrompt = localStorage.getItem('systemPrompt');
            if (localStorage.getItem('isPro') === 'true' && systemPrompt && systemPrompt.trim() !== '') {
                generatedPrompt += `<strong>[SYSTEM INSTRUCTION]:</strong> ${systemPrompt}\n\n`;
            }

            generatedPrompt += `"Act as a high-level specialist in this field. My goal is to <strong>${goal}</strong>. 
<br><br>
Please provide a response that is <strong>${keywords}</strong> in tone. 
Incorporate these specific requirements: <strong>${values}</strong>. 
<br><br>
<strong>Format instructions:</strong> Provide a step-by-step guide with at least a depth level of ${complexity}/10. Break the answer down into actionable headers and bold the most important advice."`;

            // Save to database
            try {
                await savePromptToHistory({
                    goal: goal,
                    keywords: keywords,
                    complexity: complexity,
                    values: values,
                    generated_prompt: generatedPrompt
                });

                // Refresh Sidebar
                refreshSidebar();
            } catch (err) {
                console.error("Failed to save history:", err);
            } finally {
                // Success Animation state
                setTimeout(() => {
                    const loadingContainer = document.getElementById('loading-icon-container');
                    const loadingIcon = document.getElementById('loading-icon');

                    loadingContainer.className = "w-16 h-16 md:w-20 md:h-20 bg-green-500 rounded-full flex items-center justify-center mx-auto mb-6 shadow-xl shadow-green-500/30 transition-all duration-300 scale-110";
                    loadingIcon.setAttribute('data-lucide', 'check');
                    safeCreateIcons();
                }, 800);

                // Simulation Delay for visual effect, ensuring it runs no matter what
                setTimeout(() => {
                    displayResults(generatedPrompt);
                }, 1500); // Increased slightly so user can enjoy the green checkmark
            }
        }

        function displayResults(generatedPrompt) {
            document.getElementById('output-prompt').innerHTML = generatedPrompt;
            document.getElementById('processing-container').classList.add('hidden');
            document.getElementById('results-container').classList.remove('hidden');
            safeCreateIcons();
        }

        function copyText() {
            const text = document.getElementById('output-prompt').innerText;
            const btn = document.getElementById('copy-btn');

            navigator.clipboard.writeText(text).then(() => {
                const originalContent = btn.innerHTML;
                btn.innerHTML = '<i data-lucide="check" class="w-4 h-4 text-green-500"></i> <span class="text-green-600">Copied!</span>';
                safeCreateIcons();
                setTimeout(() => {
                    btn.innerHTML = originalContent;
                    safeCreateIcons();
                }, 2000);
            });
        }

        function resetApp() {
            document.getElementById('results-container').classList.add('hidden');
            document.getElementById('input-container').classList.remove('hidden');
            document.getElementById('progress-bar').style.width = '0%';
            document.getElementById('user-goal').value = '';
            document.getElementById('user-keywords').value = '';
            document.getElementById('user-values').value = '';
            document.getElementById('user-image').value = '';
            slider.value = 5;
            sliderVal.innerText = 5;
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // Dark Mode Logic
        function toggleTheme() {
            document.documentElement.classList.toggle('dark');
            // SVGs are toggled automatically via Tailwind's `dark:hidden` and `hidden dark:block` classes
        }

        // Pro Modal Logic
        function showProModal() {
            document.getElementById('pro-modal').classList.remove('hidden');
            document.body.classList.add('overflow-hidden');
        }

        function closeProModal() {
            document.getElementById('pro-modal').classList.add('hidden');
            document.body.classList.remove('overflow-hidden');
        }

        function subscribePro() {
            const btn = document.getElementById('subscribe-btn');

            // Simulated loading state
            btn.innerHTML = `<svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Processing...`;
            btn.disabled = true;

            setTimeout(() => {
                // Simulated success
                localStorage.setItem('isPro', 'true');

                const content = document.getElementById('pro-modal-content');
                content.innerHTML = `
                    <div class="text-center py-6">
                        <div class="w-16 h-16 bg-green-100 dark:bg-green-900/30 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i data-lucide="check" class="text-green-500 dark:text-green-400 w-8 h-8"></i>
                        </div>
                        <h2 class="text-2xl font-extrabold text-green-600 dark:text-green-500 mb-2">Payment Successful!</h2>
                        <p class="text-gray-500 dark:text-gray-400 mb-6">Welcome to PromptFlow Pro. You now have access to all premium features.</p>
                        <button onclick="closeProModal()" class="w-full bg-gray-100 hover:bg-gray-200 dark:bg-slate-700 dark:hover:bg-slate-600 text-gray-800 dark:text-white py-3 rounded-xl font-bold transition-colors">
                            Start Using Pro
                        </button>
                    </div>
                `;
                safeCreateIcons();
                updateUIForPro();
            }, 1500);
        }

        function updateUIForPro() {
            if (localStorage.getItem('isPro') === 'true') {
                const upgradeBtn = document.getElementById('header-upgrade-btn');
                const proBadge = document.getElementById('header-pro-badge');
                const settingsBtn = document.getElementById('header-settings-btn');

                if (upgradeBtn) upgradeBtn.classList.add('hidden');
                if (proBadge) proBadge.classList.remove('hidden');
                if (settingsBtn) settingsBtn.classList.remove('hidden');
            }
        }

        // Settings Modal Logic
        function showSettingsModal() {
            const input = document.getElementById('system-prompt-input');
            input.value = localStorage.getItem('systemPrompt') || '';
            document.getElementById('settings-modal').classList.remove('hidden');
            document.body.classList.add('overflow-hidden');
        }

        function closeSettingsModal() {
            document.getElementById('settings-modal').classList.add('hidden');
            document.body.classList.remove('overflow-hidden');
        }

        function saveSettings() {
            const input = document.getElementById('system-prompt-input').value;
            localStorage.setItem('systemPrompt', input);
            closeSettingsModal();
        }

        function downgradeToFree() {
            localStorage.removeItem('isPro');
            localStorage.removeItem('systemPrompt');
            location.reload(); // Reload the page to visibly reset all UI state to Free mode
        }

        // Export History Logic
        async function exportHistory() {
            try {
                const history = await getHistory();
                if (!history || history.length === 0) {
                    alert('No history to export!');
                    return;
                }

                let textContent = "PromptFlow History Export\n===================\n\n";
                history.forEach((item, index) => {
                    textContent += `Prompt #${index + 1}\n`;
                    textContent += `Date: ${new Date(item.created_at).toLocaleString()}\n`;
                    textContent += `Goal: ${item.goal}\n`;
                    textContent += `Keywords: ${item.keywords}\n`;
                    textContent += `Complexity: ${item.complexity}\n`;
                    textContent += `Constraint Values: ${item.values}\n`;
                    textContent += `------------------\n`;
                    // Convert breaks back to newlines for text and strip formatting
                    let rawPrompt = item.generated_prompt.replace(/<br>/g, '\n').replace(/<strong>/g, '').replace(/<\/strong>/g, '');
                    textContent += `Generated Output:\n${rawPrompt}\n\n===================\n\n`;
                });

                const blob = new Blob([textContent], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'promptflow-history.txt';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            } catch (err) {
                console.error("Export failed:", err);
                alert("Failed to export history.");
            }
        }
    </script>
</body>

</html>